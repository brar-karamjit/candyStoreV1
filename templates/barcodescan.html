{% extends 'base.html' %}

{% block title %}
Transactions
{% endblock title %}

{% block body %}
    <div class="container my-5">
        <h1 class="text-center">Scan a Barcode</h1>
        <p class="text-center mb-4">Use your device's camera to scan the barcode of a product. Once scanned, you'll be redirected to the product details page.</p>
        
        <div id="interactive" class="viewport text-center">
            <video id="video" width="100%" height="auto" autoplay></video>
            <div id="result" class="mt-3"></div>
        </div>

        <div class="text-center mt-4">
            <button id="stop" class="btn btn-danger">Stop Scanning</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.0/quagga.min.js"></script>
    <script>
        // Initialize Quagga for live barcode scanning
        Quagga.init({
            inputStream: {
                type: "LiveStream",
                target: document.querySelector('#video'), // Set the target to the video element
                constraints: {
                    facingMode: "environment" // Use the back camera on mobile devices
                }
            },
            decoder: {
                readers: ["code_128_reader"] // Specify the type of barcode to read
            }
        }, function(err) {
            if (err) {
                console.log(err);
                return;
            }
            Quagga.start(); // Start the camera feed
        });

        Quagga.onDetected(function(data) {
            console.log(data);
            const barcode = data.codeResult.code; // Extract the scanned barcode
            // Redirect to the product page using barcode as ID
            window.location.href = `/products/${barcode}/`; 
        });

        // Stop scanning function
        document.getElementById('stop').addEventListener('click', function() {
            Quagga.stop(); // Stop the camera feed
        });
    </script>

{% endblock body %}
